#!/bin/bash
# TeamReel Constitutional Pre-push Hook (Bash)
# Enforces quality gates before allowing pushes
# SE Principle Focus: Maintainability (quality gates) and Defensibility (secure operations)

set -e  # Exit on any error

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(git rev-parse --show-toplevel)"
CONSTITUTIONAL_VALIDATOR="$REPO_ROOT/src/constitutional_validator.py"
GIT_REPORTER="$REPO_ROOT/src/git_reporter.py"
QUALITY_GATES="$REPO_ROOT/src/quality_gates.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored messages
print_message() {
    local color="$1"
    local message="$2"
    echo -e "${color}${message}${NC}"
}

# Check if Python is available
check_python() {
    if ! command -v python3 &> /dev/null && ! command -v python &> /dev/null; then
        print_message "$RED" "‚ùå Error: Python not found. Please install Python 3.7+ to use constitutional hooks."
        exit 1
    fi
    
    # Prefer python3, fallback to python
    if command -v python3 &> /dev/null; then
        PYTHON_CMD="python3"
    else
        PYTHON_CMD="python"
    fi
}

# Validate prerequisites exist
check_prerequisites() {
    if [[ ! -f "$CONSTITUTIONAL_VALIDATOR" ]]; then
        print_message "$RED" "‚ùå Error: Constitutional validator not found at $CONSTITUTIONAL_VALIDATOR"
        print_message "$YELLOW" "üí° Make sure WP01 Constitutional Core Engine is implemented"
        exit 1
    fi
    
    if [[ ! -f "$QUALITY_GATES" ]]; then
        print_message "$RED" "‚ùå Error: Quality gates module not found at $QUALITY_GATES"
        print_message "$YELLOW" "üí° Make sure quality gates are implemented"
        exit 1
    fi
    
    # Test if modules can be imported
    if ! $PYTHON_CMD -c "import sys; sys.path.insert(0, '$REPO_ROOT'); from src.constitutional_validator import ConstitutionalValidator; from src.quality_gates import QualityGateValidator" 2>/dev/null; then
        print_message "$RED" "‚ùå Error: Required modules cannot be imported"
        print_message "$YELLOW" "üí° Check Python dependencies and module structure"
        exit 1
    fi
}

# Get commits being pushed
get_push_commits() {
    local remote="$1"
    local url="$2"
    
    # Read from stdin (format: <local ref> <local sha1> <remote ref> <remote sha1>)
    while read local_ref local_sha remote_ref remote_sha; do
        if [[ "$local_sha" != "0000000000000000000000000000000000000000" ]]; then
            if [[ "$remote_sha" == "0000000000000000000000000000000000000000" ]]; then
                # New branch, get all commits
                git rev-list "$local_sha" --not --remotes=origin
            else
                # Existing branch, get new commits
                git rev-list "$remote_sha..$local_sha"
            fi
        fi
    done
}

# Get files changed in commits being pushed
get_changed_files() {
    local commits=()
    
    # Read commits into array
    while IFS= read -r -d '' commit; do
        commits+=("$commit")
    done < <(get_push_commits "$@" | tr '\n' '\0')
    
    if [[ ${#commits[@]} -eq 0 ]]; then
        return 0
    fi
    
    # Get all files changed in these commits
    printf '%s\n' "${commits[@]}" | xargs git diff --name-only 2>/dev/null | sort -u
}

# Run comprehensive quality gate validation
run_quality_gates() {
    print_message "$BLUE" "üöß Running quality gate validation..."
    
    # Create temporary script for quality gate validation
    local temp_script=$(mktemp)
    cat > "$temp_script" << 'EOF'
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from src.constitutional_validator import ConstitutionalValidator
from src.quality_gates import QualityGateValidator
from src.git_reporter import GitViolationReporter, GitReportFormat

def main():
    # Initialize validators and reporter
    constitutional_validator = ConstitutionalValidator()
    quality_validator = QualityGateValidator()
    reporter = GitViolationReporter(GitReportFormat.TERMINAL)
    
    # Get changed files from command line args
    changed_files = sys.argv[1:] if len(sys.argv) > 1 else []
    
    print(f"üîç Validating {len(changed_files)} changed file(s)...")
    
    # Run constitutional validation on all changed files
    constitutional_violations = False
    for file_path in changed_files:
        if os.path.exists(file_path):
            try:
                result = constitutional_validator.validate_file(file_path)
                if result.violations:
                    constitutional_violations = True
                    reporter.report_file_violations(file_path, result.violations)
            except Exception as e:
                print(f"‚ö†Ô∏è  Warning: Could not validate {file_path}: {e}")
    
    # Run quality gate validation
    print("\nüèÅ Running quality gate checks...")
    try:
        quality_result = quality_validator.validate_repository(".")
        
        if not quality_result.passed:
            print("‚ùå Quality gate validation failed:")
            for gate_name, gate_result in quality_result.gate_results.items():
                if not gate_result.passed:
                    print(f"  ‚Ä¢ {gate_name}: {gate_result.message}")
            return 1
            
    except Exception as e:
        print(f"‚ö†Ô∏è  Warning: Quality gate validation failed: {e}")
        # Don't block push for quality gate errors, just warn
    
    if constitutional_violations:
        print("\n‚ùå Constitutional violations detected. Push blocked.")
        print("üí° Fix the violations above and try pushing again.")
        return 1
    else:
        print("‚úÖ All quality gates passed")
        return 0

if __name__ == "__main__":
    sys.exit(main())
EOF
    
    # Get changed files for this push
    local changed_files=()
    while IFS= read -r -d '' file; do
        changed_files+=("$file")
    done < <(get_changed_files "$@" | tr '\n' '\0')
    
    # Run quality gate validation
    if $PYTHON_CMD "$temp_script" "${changed_files[@]}"; then
        rm -f "$temp_script"
        return 0
    else
        rm -f "$temp_script"
        return 1
    fi
}

# Main execution
main() {
    print_message "$BLUE" "üèõÔ∏è  TeamReel Constitutional Pre-push Hook"
    print_message "$BLUE" "===================================="
    
    # Perform prerequisite checks
    check_python
    check_prerequisites
    
    # Run quality gate validation
    if run_quality_gates "$@"; then
        print_message "$GREEN" "üéâ Pre-push validation completed successfully"
        exit 0
    else
        print_message "$RED" "üí• Pre-push validation failed"
        exit 1
    fi
}

# Execute main function with all arguments
main "$@"