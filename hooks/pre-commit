#!/bin/bash
# TeamReel Constitutional Pre-commit Hook (Bash)
# Validates SE principles before allowing commits
# SE Principle Focus: Defensibility (secure git operations) and Simplicity (fast feedback)

set -e  # Exit on any error

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(git rev-parse --show-toplevel)"
CONSTITUTIONAL_VALIDATOR="$REPO_ROOT/src/constitutional_validator.py"
GIT_REPORTER="$REPO_ROOT/src/git_reporter.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored messages
print_message() {
    local color="$1"
    local message="$2"
    echo -e "${color}${message}${NC}"
}

# Check if Python is available
check_python() {
    if ! command -v python3 &> /dev/null && ! command -v python &> /dev/null; then
        print_message "$RED" "‚ùå Error: Python not found. Please install Python 3.7+ to use constitutional hooks."
        exit 1
    fi
    
    # Prefer python3, fallback to python
    if command -v python3 &> /dev/null; then
        PYTHON_CMD="python3"
    else
        PYTHON_CMD="python"
    fi
}

# Validate constitutional validator exists
check_constitutional_validator() {
    if [[ ! -f "$CONSTITUTIONAL_VALIDATOR" ]]; then
        print_message "$RED" "‚ùå Error: Constitutional validator not found at $CONSTITUTIONAL_VALIDATOR"
        print_message "$YELLOW" "üí° Make sure WP01 Constitutional Core Engine is implemented"
        exit 1
    fi
    
    # Test if the validator can be imported
    if ! $PYTHON_CMD -c "import sys; sys.path.insert(0, '$REPO_ROOT'); from src.constitutional_validator import ConstitutionalValidator" 2>/dev/null; then
        print_message "$RED" "‚ùå Error: Constitutional validator cannot be imported"
        print_message "$YELLOW" "üí° Check Python dependencies and module structure"
        exit 1
    fi
}

# Get staged files for validation
get_staged_files() {
    # Get all staged files, excluding deleted files
    git diff --cached --name-only --diff-filter=ACM
}

# Run constitutional validation on staged files
run_constitutional_validation() {
    local staged_files=()
    
    # Read staged files into array
    while IFS= read -r -d '' file; do
        staged_files+=("$file")
    done < <(get_staged_files | tr '\n' '\0')
    
    if [[ ${#staged_files[@]} -eq 0 ]]; then
        print_message "$BLUE" "‚ÑπÔ∏è  No staged files to validate"
        return 0
    fi
    
    print_message "$BLUE" "üîç Running constitutional validation on ${#staged_files[@]} staged file(s)..."
    
    # Create temporary script for validation
    local temp_script=$(mktemp)
    cat > "$temp_script" << 'EOF'
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from src.constitutional_validator import ConstitutionalValidator
from src.git_reporter import GitViolationReporter, GitReportFormat

def main():
    # Initialize validator and reporter
    validator = ConstitutionalValidator()
    reporter = GitViolationReporter(GitReportFormat.TERMINAL)
    
    # Get staged files from command line args
    staged_files = sys.argv[1:]
    
    if not staged_files:
        print("‚ÑπÔ∏è  No files to validate")
        return 0
    
    # Validate each staged file
    violations_found = False
    for file_path in staged_files:
        if os.path.exists(file_path):
            try:
                # Run validation
                result = validator.validate_file(file_path)
                
                if result.violations:
                    violations_found = True
                    # Report violations using git reporter
                    reporter.report_file_violations(file_path, result.violations)
                    
            except Exception as e:
                print(f"‚ö†Ô∏è  Warning: Could not validate {file_path}: {e}")
    
    if violations_found:
        print("\n‚ùå Constitutional violations detected. Commit blocked.")
        print("üí° Fix the violations above and try committing again.")
        return 1
    else:
        print("‚úÖ Constitutional validation passed")
        return 0

if __name__ == "__main__":
    sys.exit(main())
EOF
    
    # Run validation with staged files as arguments
    if $PYTHON_CMD "$temp_script" "${staged_files[@]}"; then
        rm -f "$temp_script"
        return 0
    else
        rm -f "$temp_script"
        return 1
    fi
}

# Main execution
main() {
    print_message "$BLUE" "üèõÔ∏è  TeamReel Constitutional Pre-commit Hook"
    print_message "$BLUE" "=================================="
    
    # Perform prerequisite checks
    check_python
    check_constitutional_validator
    
    # Run constitutional validation
    if run_constitutional_validation; then
        print_message "$GREEN" "üéâ Pre-commit validation completed successfully"
        exit 0
    else
        print_message "$RED" "üí• Pre-commit validation failed"
        exit 1
    fi
}

# Execute main function
main "$@"