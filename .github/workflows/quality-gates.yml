name: Quality Gates Validation

on:
  pull_request:
    branches: [ main, develop, release/* ]
    types: [ opened, synchronize, reopened ]
  push:
    branches: [ main, develop, release/* ]
  workflow_dispatch:
    inputs:
      validation-scope:
        description: 'Validation scope (all, changed-files, or path)'
        required: false
        default: 'changed-files'
      strictness:
        description: 'Validation strictness (error, warning, info)'
        required: false
        default: 'error'

env:
  PYTHON_VERSION: '3.11'

jobs:
  quality-gates:
    name: Quality Gates Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    strategy:
      fail-fast: false
      matrix:
        gate:
          - name: 'constitutional-compliance'
            description: 'Constitutional Compliance (SE Principles)'
          - name: 'code-coverage'
            description: 'Code Coverage (30% minimum)'
          - name: 'code-complexity'
            description: 'Cyclomatic Complexity (â‰¤10)'
          - name: 'linting'
            description: 'Code Linting (Zero violations)'
          - name: 'security-scan'
            description: 'Security Vulnerabilities'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest pytest-cov bandit safety
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      
      - name: Quality Gate - Constitutional Compliance
        if: matrix.gate.name == 'constitutional-compliance'
        uses: ./.github/actions/constitutional-validator
        id: constitutional
        with:
          validation-scope: ${{ github.event.inputs.validation-scope || 'changed-files' }}
          strictness: ${{ github.event.inputs.strictness || 'error' }}
          report-format: 'github'
          fail-on-violations: 'true'
      
      - name: Quality Gate - Code Coverage
        if: matrix.gate.name == 'code-coverage'
        id: coverage
        run: |
          echo "ðŸ§ª Running code coverage analysis..."
          PYTHON_FILES=$(find . -name "*.py" -not -path "./.git/*" -not -path "./.*" | head -1)
          if [ -z "$PYTHON_FILES" ]; then
            echo "No Python files found - skipping coverage"
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "coverage=100" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -d "tests" ] || [ -d "test" ]; then
            pytest --cov=. --cov-report=json --cov-report=term --cov-fail-under=30 || COVERAGE_FAILED=true
          else
            pytest --cov=. --cov-report=json --cov-report=term || COVERAGE_FAILED=true
          fi
          if [ -f coverage.json ]; then
            COVERAGE=$(python -c "import json; data=json.load(open('coverage.json')); print(data['totals']['percent_covered'])")
            echo "Coverage: ${COVERAGE}%"
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            if (( $(echo "$COVERAGE < 30" | bc -l) )); then
              echo "âŒ Coverage below 30%: ${COVERAGE}%"
              echo "result=fail" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "result=pass" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Coverage report not generated"
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Quality Gate - Code Complexity
        if: matrix.gate.name == 'code-complexity'
        id: complexity
        run: |
          echo "ðŸ”„ Analyzing complexity..."
          COMPLEXITY_VIOLATIONS=0
          if ruff check --select C901 --output-format=json . > complexity.json 2>/dev/null; then
            COMPLEXITY_VIOLATIONS=$(python -c "import json; data=json.load(open('complexity.json')); print(len(data))")
          fi
          echo "violations=$COMPLEXITY_VIOLATIONS" >> $GITHUB_OUTPUT
          if [ "$COMPLEXITY_VIOLATIONS" -gt 0 ]; then
            echo "âŒ Complexity violations: $COMPLEXITY_VIOLATIONS"
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi
      
      - name: Quality Gate - Linting
        if: matrix.gate.name == 'linting'
        id: linting
        run: |
          echo "ðŸ” Linting..."
          if [ -n "$GITHUB_BASE_REF" ]; then
            git fetch origin $GITHUB_BASE_REF --depth=1 >/dev/null 2>&1 || true
            CHANGED_PY_FILES=$(git diff --name-only origin/$GITHUB_BASE_REF...HEAD | grep '\.py$' || true)
          else
            CHANGED_PY_FILES=$(git diff --name-only HEAD~1 | grep '\.py$' || true)
          fi

          if [ -z "$CHANGED_PY_FILES" ]; then
            echo "No Python changes detected - skipping lint"
            echo "violations=0" >> $GITHUB_OUTPUT
            echo "result=pass" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "$CHANGED_PY_FILES" > changed_python_files.txt
          echo "Files to lint:"
          cat changed_python_files.txt

          LINT_INPUT=$(tr '\n' ' ' < changed_python_files.txt)
          ruff check --output-format=json --exit-zero $LINT_INPUT > linting.json
          LINT_VIOLATIONS=$(python -c "import json; data=json.load(open('linting.json')); print(len(data) if isinstance(data, list) else 0)")

          echo "violations=$LINT_VIOLATIONS" >> $GITHUB_OUTPUT
          if [ "$LINT_VIOLATIONS" -gt 0 ]; then
            echo "âŒ Lint violations"
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi
      
      - name: Quality Gate - Security Scan
        if: matrix.gate.name == 'security-scan'
        id: security
        run: |
          echo "ðŸ›¡ Security scan..."
          SECURITY_ISSUES=0
          if bandit -r . -f json -o bandit.json 2>/dev/null; then
            SECURITY_ISSUES=$(python -c "import json; data=json.load(open('bandit.json')); print(len(data.get('results', [])))")
          fi
          DEPENDENCY_ISSUES=0
          if pip freeze | safety check --json > safety.json 2>/dev/null; then
            DEPENDENCY_ISSUES=0
          else
            if [ -f safety.json ]; then
              DEPENDENCY_ISSUES=$(python -c "import json; data=json.load(open('safety.json')); print(len(data))" 2>/dev/null || echo 0)
            fi
          fi
          TOTAL=$(($SECURITY_ISSUES + $DEPENDENCY_ISSUES))
          echo "issues=$TOTAL" >> $GITHUB_OUTPUT
          if [ "$TOTAL" -gt 0 ]; then
            echo "âŒ Vulnerabilities"
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload quality gate reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-reports-${{ matrix.gate.name }}
          path: |
            constitutional-compliance-report.json
            coverage.json
            complexity.json
            linting.json
            bandit.json
            safety.json
          retention-days: 30

  quality-gates-summary:
    name: Quality Gates Summary
    runs-on: ubuntu-latest
    needs: quality-gates
    if: always()
    
    steps:
      - name: Generate report
        run: |
          echo "# ðŸ—ï¸ Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.quality-gates.result }}" != "success" ]; then
            echo "âŒ Some quality gates failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… All quality gates passed" >> $GITHUB_STEP_SUMMARY
          fi
